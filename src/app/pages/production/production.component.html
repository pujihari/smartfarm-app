<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">Recording</h1>
    <!-- Tombol '+ Tambah Data Tunggal' dihapus -->
  </div>

  <!-- Batch Input Section -->
  @if (authService.canWriteData$ | async) {
    <div class="batch-input-container">
      <h2>Input Data Harian Flok</h2>
      <form [formGroup]="batchProductionForm" class="batch-form">
        <div class="form-row top-row">
          <div class="form-group">
            <label for="batch_farm_filter">Filter Farm (Opsional)</label>
            <select id="batch_farm_filter" formControlName="farm_filter">
              <option [ngValue]="null">Tampilkan Semua Farm</option>
              @if (farms$ | async; as farms) {
                @for (farm of farms; track farm.id) {
                  <option [value]="farm.id">{{ farm.name }}</option>
                }
              }
            </select>
          </div>
          <div class="form-group">
            <label for="batch_flock_id">Flok <span class="required-indicator">*</span></label>
            <select id="batch_flock_id" formControlName="flock_id">
              <option [ngValue]="null" disabled>Pilih Flok</option>
              @if (flocks$ | async; as flocks) {
                @for (flock of flocks; track flock.id) {
                  <option [value]="flock.id">{{ flock.name }} ({{ flock.farmName }})</option>
                }
              }
            </select>
          </div>
          <div class="form-group">
            <label for="batch_date">Tanggal <span class="required-indicator">*</span></label>
            <input id="batch_date" type="date" formControlName="date">
          </div>
        </div>
        
        @if (currentFlockAgeInDays !== null) {
          <div class="flock-age-info">
            Umur Flok pada tanggal ini: <strong>{{ currentFlockAgeInDays }} hari</strong>
          </div>
        }

        <fieldset>
          <legend>Deplesi Harian</legend>
          <div class="form-row">
            <div class="form-group">
              <label for="batch_mortality">Kematian <span class="required-indicator">*</span></label>
              <input id="batch_mortality" type="number" formControlName="mortality_count">
            </div>
            <div class="form-group">
              <label for="batch_culling">Culling <span class="required-indicator">*</span></label>
              <input id="batch_culling" type="number" formControlName="culling_count">
            </div>
          </div>
        </fieldset>

        <fieldset formArrayName="feed_consumption">
          <legend>Konsumsi Pakan</legend>
          @for (feed of batch_feed_consumption.controls; track $index) {
            <div class="feed-row" [formGroupName]="$index">
              <select formControlName="feed_code">
                <option [ngValue]="''" disabled>Pilih Kode Pakan <span class="required-indicator">*</span></option>
                @for (option of feedOptions; track option.item_code) {
                  <option [value]="option.item_code">{{ option.name }} ({{ option.item_code }})</option>
                }
              </select>
              <input type="number" formControlName="quantity_kg" placeholder="Jumlah (kg) *" step="0.01">
              <button type="button" class="remove-feed-btn" (click)="removeFeedFromBatchForm($index)" [disabled]="batch_feed_consumption.controls.length === 1">Hapus</button>
            </div>
          }
          <button type="button" class="add-feed-btn" (click)="addFeedToBatchForm()">+ Tambah Pakan</button>
        </fieldset>

        @if (showEggProductionFields) {
          <div>
            <fieldset class="egg-quality-group">
              <legend>Produksi Telur (butir)</legend>
              <div class="form-row">
                <div class="form-group">
                  <label for="batch_normal_eggs">Normal <span class="required-indicator">*</span></label>
                  <input id="batch_normal_eggs" type="number" formControlName="normal_eggs">
                </div>
                <div class="form-group">
                  <label for="batch_white_eggs">Putih/Pucat <span class="required-indicator">*</span></label>
                  <input id="batch_white_eggs" type="number" formControlName="white_eggs">
                </div>
                <div class="form-group">
                  <label for="batch_cracked_eggs">Retak <span class="required-indicator">*</span></label>
                  <input id="batch_cracked_eggs" type="number" formControlName="cracked_eggs">
                </div>
              </div>
            </fieldset>

            <fieldset class="egg-quality-group">
              <legend>Produksi Telur (kilo)</legend>
              <div class="form-row">
                <div class="form-group">
                  <label for="batch_normal_eggs_weight_kg">Normal <span class="required-indicator">*</span></label>
                  <input id="batch_normal_eggs_weight_kg" type="number" formControlName="normal_eggs_weight_kg" step="0.01">
                </div>
                <div class="form-group">
                  <label for="batch_white_eggs_weight_kg">Putih/Pucat <span class="required-indicator">*</span></label>
                  <input id="batch_white_eggs_weight_kg" type="number" formControlName="white_eggs_weight_kg" step="0.01">
                </div>
                <div class="form-group">
                  <label for="batch_cracked_eggs_weight_kg">Retak <span class="required-indicator">*</span></label>
                  <input id="batch_cracked_eggs_weight_kg" type="number" formControlName="cracked_eggs_weight_kg" step="0.01">
                </div>
              </div>
            </fieldset>
          </div>
        }

        <div class="form-group">
          <label for="batch_notes">Catatan (Opsional)</label>
          <textarea id="batch_notes" formControlName="notes" rows="3" placeholder="Tambahkan catatan harian di sini..."></textarea>
        </div>

        <button type="button" class="add-to-stage-btn" (click)="addToStage()" [disabled]="batchProductionForm.invalid">
          {{ isEditingExistingEntry ? 'Perbarui Data Harian' : 'Tambah ke Daftar' }}
        </button>
      </form>

      @if (stagedProductionData.length > 0) {
        <div class="staging-area">
          <h3>Data yang Akan Disimpan</h3>
          <div class="table-container">
            <table class="staging-table">
              <thead>
                <tr>
                  <th>Flok</th>
                  <th>Tanggal</th>
                  <th>Deplesi</th>
                  <th>Telur (butir)</th>
                  <th>Pakan (kg)</th>
                  <th>Catatan</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                @for (item of stagedProductionData; track $index) {
                  <tr>
                    <td>{{ item.flockName }}</td>
                    <td>{{ item.date | date: 'dd/MM/yy' }}</td>
                    <td>{{ item.totalDepletion }}</td>
                    <td>{{ item.totalEggCount.toLocaleString('id-ID') }}</td>
                    <td>{{ item.totalFeedConsumption.toLocaleString('id-ID') }}</td>
                    <td>{{ item.notes || '-' }}</td>
                    <td><button class="action-btn delete-btn" (click)="removeFromStage($index)">Hapus</button></td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
          <button class="save-all-btn" (click)="saveStagedData()" [disabled]="isSavingBatch">
            {{ isSavingBatch ? 'Menyimpan...' : 'Simpan Semua ke Database' }}
          </button>
        </div>
      }
    </div>
  }

  <div class="table-container main-table">
    <table class="production-table">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Farm</th>
          <th>Flok</th>
          <th>Deplesi (ekor)</th>
          <th>Total Telur (butir)</th>
          <th>Total Produksi (kg)</th>
          <th>Total Pakan (kg)</th>
          <th>Catatan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        @if (productionData$ | async; as data) {
          @for (item of data; track item.id) {
            <tr>
              <td data-label="Tanggal">{{ item.date | date: 'dd MMMM yyyy' }}</td>
              <td data-label="Farm">{{ item.farmName }}</td>
              <td data-label="Flok">{{ item.flockName }}</td>
              <td data-label="Deplesi (ekor)">{{ item.totalDepletion }}</td>
              <td data-label="Total Telur (butir)">{{ item.totalEggCount.toLocaleString('id-ID') }}</td>
              <td data-label="Total Produksi (kg)">{{ item.totalEggWeightKg.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</td>
              <td data-label="Total Pakan (kg)">{{ item.totalFeedConsumption.toLocaleString('id-ID') }}</td>
              <td data-label="Catatan">{{ item.notes || '-' }}</td>
              <td data-label="Aksi">
                @if (authService.canWriteData$ | async) {
                  <div class="action-buttons">
                    <button class="action-btn edit-btn" (click)="editDailyEntry(item)">Edit</button> <!-- Mengubah openEditModal menjadi editDailyEntry -->
                    <button class="action-btn delete-btn" (click)="openDeleteModal(item)">Hapus</button>
                  </div>
                }
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="9" class="empty-state">Belum ada data produksi.</td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>
</div>

<!-- Komponen app-production-modal dihapus -->

@if (isConfirmModalOpen) {
  <app-confirmation-modal
    (confirm)="confirmDelete()"
    (cancel)="closeDeleteModal()">
  </app-confirmation-modal>
}