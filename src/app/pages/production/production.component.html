<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">Recording {{ productionType === 'grower' ? 'Grower' : 'Layer' }}</h1>
  </div>

  <!-- Daily Input Section -->
  @if (authService.canWriteData$ | async) {
    <div class="batch-input-container">
      <h2>Input Data Harian Flok</h2>
  <form [formGroup]="dailyProductionForm" class="batch-form" (ngSubmit)="onSubmit()">
        <div class="form-row top-row">
          <div class="form-group">
            <label for="daily_farm_filter">Filter Farm (Opsional)</label>
            <select id="daily_farm_filter" formControlName="farm_filter">
              <option [ngValue]="null">Tampilkan Semua Farm</option>
              @if (filteredFarms$ | async; as farms) {
                @for (farm of farms; track farm.id) {
                  <option [value]="farm.id">{{ farm.name }}</option>
                }
              }
            </select>
          </div>
          <div class="form-group">
            <label for="daily_flock_id">Flok <span class="required-indicator">*</span></label>
            <select id="daily_flock_id" formControlName="flock_id" [class.is-invalid]="dailyProductionForm.get('flock_id')?.invalid && dailyProductionForm.get('flock_id')?.touched">
              <option [ngValue]="null" disabled>Pilih Flok</option>
              @if (filteredFlocks$ | async; as flocks) {
                @for (flock of flocks; track flock.id) {
                  <option [value]="flock.id">{{ flock.name }} ({{ flock.farmName }})</option>
                }
              }
            </select>
            @if (dailyProductionForm.get('flock_id')?.invalid && dailyProductionForm.get('flock_id')?.touched) {
              <div class="invalid-feedback">Flok wajib diisi.</div>
            }
          </div>
          <div class="form-group">
            <label for="daily_date">Tanggal <span class="required-indicator">*</span></label>
            <input id="daily_date" type="date" formControlName="date" [class.is-invalid]="dailyProductionForm.get('date')?.invalid && dailyProductionForm.get('date')?.touched">
            @if (dailyProductionForm.get('date')?.invalid && dailyProductionForm.get('date')?.touched) {
              <div class="invalid-feedback">Tanggal wajib diisi.</div>
            }
          </div>
        </div>
        
        @if (currentFlockAgeInDays !== null) {
          <div class="flock-age-info">
            Umur Flok pada tanggal ini: <strong>{{ currentFlockAgeInDays }} hari</strong>
          </div>
        }

        <fieldset>
          <legend>Deplesi Harian</legend>
          <div class="form-row">
            <div class="form-group">
              <label for="daily_mortality">Kematian <span class="required-indicator">*</span></label>
              <input id="daily_mortality" type="number" formControlName="mortality_count" (input)="onMortalityInputChange($event)" [class.is-invalid]="dailyProductionForm.get('mortality_count')?.invalid && dailyProductionForm.get('mortality_count')?.touched">
              @if (dailyProductionForm.get('mortality_count')?.invalid && dailyProductionForm.get('mortality_count')?.touched) {
                <div class="invalid-feedback">Jumlah kematian wajib diisi dan minimal 0.</div>
              }
            </div>
            <div class="form-group">
              <label for="daily_culling">Culling <span class="required-indicator">*</span></label>
              <input id="daily_culling" type="number" formControlName="culling_count" (input)="onCullingInputChange($event)" [class.is-invalid]="dailyProductionForm.get('culling_count')?.invalid && dailyProductionForm.get('culling_count')?.touched">
              @if (dailyProductionForm.get('culling_count')?.invalid && dailyProductionForm.get('culling_count')?.touched) {
                <div class="invalid-feedback">Jumlah culling wajib diisi dan minimal 0.</div>
              }
            </div>
          </div>
          @if (totalDepletion$ | async; as totalDepletion) {
            <p class="calculated-total">Total Deplesi: <strong>{{ totalDepletion }} ekor</strong></p>
          }
        </fieldset>

        <fieldset formArrayName="feed_consumption">
          <legend>Konsumsi Pakan</legend>
          <!-- Assuming only one feed row now -->
          @if (daily_feed_consumption.at(0); as feed) {
            <div class="feed-row" [formGroupName]="0">
              <select formControlName="feed_code" [class.is-invalid]="feed.invalid && feed.touched && feed.errors?.['missingFeedCode']">
                <option [ngValue]="null">Pilih Kode Pakan</option>
                @for (option of feedOptions; track option.item_code) {
                  <option [value]="option.item_code">{{ option.name }} ({{ option.item_code }})</option>
                }
              </select>
              <input type="text" formControlName="quantity_kg" placeholder="Jumlah (kg)" (input)="onFeedQuantityChange($event, 0)" [class.is-invalid]="feed.invalid && feed.touched && feed.errors?.['invalidFeedQuantity']">
              <!-- Removed remove button -->
            </div>
            @if (feed.invalid && feed.touched) {
              @if (feed.errors?.['missingFeedCode']) {
                <div class="invalid-feedback">Kode pakan wajib diisi jika jumlah pakan diisi.</div>
              }
              @if (feed.errors?.['invalidFeedQuantity']) {
                <div class="invalid-feedback">Jumlah pakan wajib diisi dan minimal 0 jika kode pakan diisi.</div>
              }
            }
          }
          <!-- Removed add button -->
          @if (totalFeedConsumption$ | async; as totalFeedConsumption) {
            <p class="calculated-total">Total Konsumsi Pakan: <strong>{{ totalFeedConsumption.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }} kg</strong></p>
          }
        </fieldset>

        @if (showEggProductionFields) {
          <fieldset>
            <legend>Produksi Telur</legend>
            <div formArrayName="egg_production_entries">
              <!-- Assuming only one egg production row now -->
              @if (eggProductionEntries.at(0); as eggEntryGroup) {
                <div [formGroupName]="0" class="egg-production-row-group">
                  <div class="egg-type-input-group">
                    <label>Normal</label>
                    <div class="input-pair">
                      <input type="text" formControlName="normal_count" placeholder="Butir" (input)="onEggInputChange($event, 'normal_count', 0)" [class.is-invalid]="eggEntryGroup.get('normal_count')?.invalid && eggEntryGroup.get('normal_count')?.touched">
                      <input type="text" formControlName="normal_weight" placeholder="Kilo" (input)="onEggInputChange($event, 'normal_weight', 0)" [class.is-invalid]="eggEntryGroup.get('normal_weight')?.invalid && eggEntryGroup.get('normal_weight')?.touched">
                    </div>
                    @if (eggEntryGroup.get('normal_count')?.invalid && eggEntryGroup.get('normal_count')?.touched) {
                      <div class="invalid-feedback">Butir normal minimal 0.</div>
                    }
                    @if (eggEntryGroup.get('normal_weight')?.invalid && eggEntryGroup.get('normal_weight')?.touched) {
                      <div class="invalid-feedback">Kilo normal minimal 0.</div>
                    }
                  </div>
                  <div class="egg-type-input-group">
                    <label>Putih</label>
                    <div class="input-pair">
                      <input type="text" formControlName="white_count" placeholder="Butir" (input)="onEggInputChange($event, 'white_count', 0)" [class.is-invalid]="eggEntryGroup.get('white_count')?.invalid && eggEntryGroup.get('white_count')?.touched">
                      <input type="text" formControlName="white_weight" placeholder="Kilo" (input)="onEggInputChange($event, 'white_weight', 0)" [class.is-invalid]="eggEntryGroup.get('white_weight')?.invalid && eggEntryGroup.get('white_weight')?.touched">
                    </div>
                    @if (eggEntryGroup.get('white_count')?.invalid && eggEntryGroup.get('white_count')?.touched) {
                      <div class="invalid-feedback">Butir putih minimal 0.</div>
                    }
                    @if (eggEntryGroup.get('white_weight')?.invalid && eggEntryGroup.get('white_weight')?.touched) {
                      <div class="invalid-feedback">Kilo putih minimal 0.</div>
                    }
                  </div>
                  <div class="egg-type-input-group">
                    <label>Retak</label>
                    <div class="input-pair">
                      <input type="text" formControlName="cracked_count" placeholder="Butir" (input)="onEggInputChange($event, 'cracked_count', 0)" [class.is-invalid]="eggEntryGroup.get('cracked_count')?.invalid && eggEntryGroup.get('cracked_count')?.touched">
                      <input type="text" formControlName="cracked_weight" placeholder="Kilo" (input)="onEggInputChange($event, 'cracked_weight', 0)" [class.is-invalid]="eggEntryGroup.get('cracked_weight')?.invalid && eggEntryGroup.get('cracked_weight')?.touched">
                    </div>
                    @if (eggEntryGroup.get('cracked_count')?.invalid && eggEntryGroup.get('cracked_count')?.touched) {
                      <div class="invalid-feedback">Butir retak minimal 0.</div>
                    }
                    @if (eggEntryGroup.get('cracked_weight')?.invalid && eggEntryGroup.get('cracked_weight')?.touched) {
                      <div class="invalid-feedback">Kilo retak minimal 0.</div>
                    }
                  </div>
                  <!-- Removed remove button -->
                </div>
              }
            </div>
            <!-- Removed add button -->

            <div class="total-egg-summary">
              <div class="total-egg-type-summary">
                <label>Total Normal</label>
                <div class="output-pair">
                  <span class="total-value">{{ (totalNormalEggsCount$ | async)?.toLocaleString('id-ID') }} Butir</span>
                  <span class="total-value">{{ (totalNormalEggsWeightKg$ | async)?.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }} Kilo</span>
                </div>
              </div>
              <div class="total-egg-type-summary">
                <label>Total Putih</label>
                <div class="output-pair">
                  <span class="total-value">{{ (totalWhiteEggsCount$ | async)?.toLocaleString('id-ID') }} Butir</span>
                  <span class="total-value">{{ (totalWhiteEggsWeightKg$ | async)?.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }} Kilo</span>
                </div>
              </div>
              <div class="total-egg-type-summary">
                <label>Total Retak</label>
                <div class="output-pair">
                  <span class="total-value">{{ (totalCrackedEggsCount$ | async)?.toLocaleString('id-ID') }} Butir</span>
                  <span class="total-value">{{ (totalCrackedEggsWeightKg$ | async)?.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }} Kilo</span>
                </div>
              </div>
            </div>
          </fieldset>
        }

        <div class="form-group">
          <label for="daily_notes">Catatan (Opsional)</label>
          <textarea id="daily_notes" formControlName="notes" rows="3" placeholder="Tambahkan catatan harian di sini..."></textarea>
        </div>

        <!-- Debug panel: shows why form might be invalid -->
        @if (formDebug) {
          <div class="debug-panel" style="background:#fff7c2;padding:10px;border:1px solid #f0e68c;margin-bottom:12px;">
            <strong>Debug: Form status</strong>
            <div>Status: {{ formDebug.status }} â€” Valid: {{ formDebug.valid }}</div>
            <div>Invalid controls: {{ formDebug.invalidControls?.length ? (formDebug.invalidControls.join(', ')) : '-' }}</div>
          </div>
        }

        <button type="submit" class="add-to-stage-btn" [disabled]="dailyProductionForm.invalid || isSaving">
          {{ isSaving ? 'Menyimpan...' : (isEditingExistingEntry ? 'Perbarui Data Harian' : 'Simpan Data Harian') }}
        </button>
      </form>
    </div>
  }

  <div class="table-container main-table">
    <table class="production-table">
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Farm</th>
          <th>Flok</th>
          <th>Deplesi (ekor)</th>
          <th>Total Telur (butir)</th>
          <th>Total Produksi (kg)</th>
          <th>Total Pakan (kg)</th>
          <th>Catatan</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody>
        @if (productionData$ | async; as data) {
          @for (item of data; track item.id) {
            <tr>
              <td data-label="Tanggal">{{ item.date | date: 'dd MMMM yyyy' }}</td>
              <td data-label="Farm">{{ item.farmName }}</td>
              <td data-label="Flok">{{ item.flockName }}</td>
              <td data-label="Deplesi (ekor)">{{ item.totalDepletion }}</td>
              <td data-label="Total Telur (butir)">{{ item.totalEggCount.toLocaleString('id-ID') }}</td>
              <td data-label="Total Produksi (kg)">{{ item.totalEggWeightKg.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</td>
              <td data-label="Total Pakan (kg)">{{ item.totalFeedConsumption.toLocaleString('id-ID') }}</td>
              <td data-label="Catatan">{{ item.notes || '-' }}</td>
              <td data-label="Aksi">
                @if (authService.canWriteData$ | async) {
                  <div class="action-buttons">
                    <button class="action-btn edit-btn" (click)="editDailyEntry(item)">Edit</button>
                    <button class="action-btn delete-btn" (click)="openDeleteModal(item)">Hapus</button>
                  </div>
                }
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="9" class="empty-state">Belum ada data produksi.</td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>
</div>

@if (isConfirmModalOpen) {
  <app-confirmation-modal
    (confirm)="confirmDelete()"
    (cancel)="closeDeleteModal()">
  </app-confirmation-modal>
}