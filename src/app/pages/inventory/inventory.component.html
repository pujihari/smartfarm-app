<div class="page-container">
  <div class="page-header">
    <h1 class="page-title">Manajemen Inventori</h1>
    @if (authService.isOwner$ | async) {
      <button class="add-button" (click)="openAddModal()">+ Tambah Item Baru</button>
    }
  </div>

  <div class="filter-container">
    <div class="filter-row">
      <div class="form-group">
        <label for="farmFilter">Filter Farm:</label>
        <select id="farmFilter" [(ngModel)]="selectedFarmId" (change)="onFilterChange()">
          <option [ngValue]="null">Semua Farm (Global)</option>
          @for (farm of (farms$ | async); track farm.id) {
            <option [value]="farm.id">{{ farm.name }}</option>
          }
        </select>
      </div>
      <div class="form-group">
        <label for="itemTypeFilter">Filter Jenis Item:</label>
        <select id="itemTypeFilter" [(ngModel)]="selectedItemType" (change)="onFilterChange()">
          <option [ngValue]="null">Semua Jenis</option>
          @for (type of itemTypes; track type) {
            <option [value]="type">{{ type }}</option>
          }
        </select>
      </div>
      <div class="form-group">
        <label for="searchTerm">Cari Nama/Kode Item:</label>
        <input id="searchTerm" type="text" [formControl]="searchTerm" placeholder="Cari nama atau kode...">
      </div>
    </div>
  </div>

  <!-- Global Stock Summary Section -->
  @if (selectedFarmId === null && selectedItemType === null && !searchTerm.value && (globalSummaryData$ | async) as summaryData && summaryData.length > 0) {
    <div class="inventory-group">
      <h2>Ringkasan Stok Global</h2>
      <div class="table-container">
        <table class="inventory-table summary-table">
          <thead>
            <tr>
              <th>Jenis Item</th>
              @if (true) { <!-- Always show Kode Pakan in summary for Pakan type -->
                <th>Kode Pakan</th>
              }
              <th>Nama Item</th>
              <th>Total Stok</th>
              <th>Satuan</th>
            </tr>
          </thead>
          <tbody>
            @for (summaryItem of summaryData; track summaryItem.item_type + summaryItem.name) {
              <tr>
                <td data-label="Jenis Item">{{ summaryItem.item_type }}</td>
                @if (summaryItem.item_type === 'PAKAN') {
                  <td data-label="Kode Pakan">{{ summaryItem.item_code || '-' }}</td>
                } @else {
                  <td data-label="Kode Pakan">-</td>
                }
                <td data-label="Nama Item">{{ summaryItem.name }}</td>
                <td data-label="Total Stok">{{ summaryItem.total_quantity.toLocaleString('id-ID') }}</td>
                <td data-label="Satuan">{{ summaryItem.unit }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  <div class="inventory-content">
    @if (inventoryGroups$ | async; as groups) {
      @for (group of groups; track group.type) {
        <div class="inventory-group">
          <h2>{{ group.type }}</h2>
          <div class="table-container">
            <table class="inventory-table">
              <thead>
                <tr>
                  @if (group.type === 'PAKAN') {
                    <th>Kode Pakan</th>
                  }
                  <th>Nama Item</th>
                  <th>Farm</th>
                  <th>Jumlah Stok</th>
                  <th>Satuan</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                @for (item of group.items; track item.id) {
                  <tr>
                    @if (group.type === 'PAKAN') {
                      <td data-label="Kode Pakan">{{ item.item_code }}</td>
                    }
                    <td data-label="Nama Item">{{ item.name }}</td>
                    <td data-label="Farm">{{ item.farmName }}</td>
                    <td data-label="Jumlah Stok">{{ item.quantity.toLocaleString('id-ID') }}</td>
                    <td data-label="Satuan">{{ item.unit }}</td>
                    <td data-label="Aksi">
                      @if (authService.isOwner$ | async) {
                        <div class="action-buttons">
                          <button class="action-btn edit-btn" (click)="openEditModal(item)">Edit</button>
                          <button class="action-btn delete-btn" (click)="openDeleteModal(item)">Hapus</button>
                        </div>
                      }
                    </td>
                  </tr>
                } @empty {
                  <tr>
                    <td [attr.colspan]="group.type === 'PAKAN' ? 6 : 5" class="empty-state">
                      Belum ada data untuk kategori {{ group.type }} di farm ini.
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      }
    } @else {
      <p>Memuat data inventori...</p>
    }
  </div>
</div>

@if (isModalOpen) {
  <app-inventory-modal
    [item]="itemToEdit"
    [farms]="(farms$ | async) ?? []"
    (close)="closeModal()"
    (save)="saveItem($event)">
  </app-inventory-modal>
}

@if (isConfirmModalOpen) {
  <app-confirmation-modal
    (confirm)="confirmDelete()"
    (cancel)="closeDeleteModal()">
  </app-confirmation-modal>
}